<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
  <title>tracking tool VR</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:300,400,500" rel="stylesheet">
<style>
* {
  box-sizing: border-box;
  font-family: 'Roboto Mono', monospace;
}

body {
  margin: 0;
  padding: 0;
  font-family: sans-serif;
}

#container {
  margin: 10px auto;
  border: 1px solid black;
  width: 640px;
  padding: 10px;
}

h1 {
  font-weight: 400;
  margin: 0;
}

p {
  margin: 0;
  margin-bottom: 16px;
}

a {
  color: #000;
}
a:hover, a:visited {
  color: #000;
}

#buttons {

}

#buttons input {

}

#timer {
  float: right;
}

#samples, #results {
  border: 1px solid black;
  font-size: 20px;
  padding: 3px;
  margin: 10px 0px;
}

#samples {
}

#results {
}

#credits {
  margin-top: 16px;
}
</style>
</head>
<body>
<div id="container">
  <h1>tracking tool VR</h1>
  <p>positional tracking precision tool</p>
  <div id="samples">
    position : [x,y,z]
  </div>

  <div id="buttons">
    <span id="timer">0s</span>
    <input type="button" id="start-btn" value="Start">
    <input type="button" id="pause-btn" value="Pause" style="display: none">
    <input type="button" id="stop-btn" value="Stop">
    <input type="button" id="clear-btn" value="Clear">
  </div>

  <div id="results">
    bounds : [x,y,z]
  </div>

  <div id="credits">
    mkeblx &middot; <a href="https://github.com/mkeblx/tracking-tool-vr">github</a> &middot; made with <a href="http://webvr.info">webvr</a>
  </div>

</div>

<script src="js/three.min.js"></script>
<script>

var posSamples = [];
var rotSamples = [];
var collecting = false;

var bounds = null;
var firstPos = null;
var range = null;

var samplesEl = document.getElementById('samples');
var resultsEl = document.getElementById('results');

var startBtn = document.getElementById('start-btn');
var pauseBtn = document.getElementById('pause-btn');
var stopBtn = document.getElementById('stop-btn');
var clearBtn = document.getElementById('clear-btn');

var timerEl = document.getElementById('timer');
var startTime = 0;

var vrHMD;

init();

function init() {
  navigator.getVRDisplays().then(function(displays){
    if (displays.length)
      vrHMD = displays[0];
    console.log(vrHMD);
  });


  startBtn.addEventListener('click', function(event){
    start();
  });
  pauseBtn.addEventListener('click', function(event){
    pause();
  });
  stopBtn.addEventListener('click', function(event){
    stop();
  });
  clearBtn.addEventListener('click', function(event){
    clear();
  });

  requestAnimationFrame(animate);
}

function start() {
  collecting = true;

  firstPos = null;
  bounds = new THREE.Box3();

  startTime = Date.now();
}

function stop() {
  collecting = false;
}

function pause() {
  collecting = false;
}

function clear() {
  samples = [];

  samplesEl.innerHTML = 'position : [x,y,z]';
  resultsEl.innerHTML = 'bounds : [x,y,z]';

  timerEl.innerHTML = '0s';
  startTime = 0;
}

// format point
function format(pt, n, units) {
  units = units || '';
  n = n || 5;
  return pt[0].toFixed(n) +units+", " + pt[1].toFixed(n) +units+", " + pt[2].toFixed(n) +units;
}

function calculate() {
  var vec = new THREE.Vector3().fromArray(firstPos);

  var b = bounds.clone();

  b.translate( vec.negate() );

  var range = [];
  range[0] = Math.abs(b.max.x - b.min.x) * 1000;
  range[1] = Math.abs(b.max.y - b.min.y) * 1000;
  range[2] = Math.abs(b.max.z - b.min.z) * 1000;
  resultsEl.innerHTML = format(range, 3, "mm");
}

function animate(t) {
  if (collecting) {

    if (vrHMD) {
      var pose = vrHMD.getPose();

      var position = pose.position;
      var orientation = pose.orientation;

      samplesEl.innerHTML = format(position);

      if (bounds.isEmpty()) {
        firstPos = position;
      }

      bounds.expandByPoint({ x: position[0], y: position[1], z: position[2] });

      if (firstPos != null)
        calculate();
    }

    timerEl.innerHTML = ((Date.now() - startTime) / 1000).toFixed(2) + "s";

  }

  requestAnimationFrame(animate);
}


</script>
</body>
</html>
